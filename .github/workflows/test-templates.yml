name: Test Cookiecutter Templates

on:
  pull_request:
    paths:
      - 'opentofu/**'
      - 'bicep/**'
      - '*.json'
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # Test 1: Validate template structure
  validate-template-structure:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        template: [opentofu, bicep]
    steps:
      - uses: actions/checkout@v4

      - name: Check template directory exists
        run: |
          if [ ! -d "${{ matrix.template }}" ]; then
            echo "âŒ Template directory not found: ${{ matrix.template }}"
            exit 1
          fi
          echo "âœ… Template directory exists"

      - name: Validate cookiecutter.json
        run: |
          if [ ! -f "${{ matrix.template }}/cookiecutter.json" ]; then
            echo "âŒ cookiecutter.json not found"
            exit 1
          fi

          # Validate JSON syntax
          if ! jq empty "${{ matrix.template }}/cookiecutter.json" 2>/dev/null; then
            echo "âŒ Invalid JSON in cookiecutter.json"
            exit 1
          fi

          echo "âœ… cookiecutter.json is valid JSON"

      - name: Check required template files
        run: |
          cd ${{ matrix.template }}

          # Check for README
          if [ ! -f "README.md" ]; then
            echo "âš ï¸  README.md not found in template"
          fi

          # Check for template directory
          TEMPLATE_DIR=$(jq -r '.repo_name' cookiecutter.json)
          if [ ! -d "{{cookiecutter.repo_name}}" ]; then
            echo "âŒ Template directory {{cookiecutter.repo_name}} not found"
            exit 1
          fi

          echo "âœ… Required template files present"

  # Test 2: Generate repos from templates
  test-template-generation:
    runs-on: ubuntu-latest
    needs: validate-template-structure
    strategy:
      matrix:
        template:
          - name: opentofu
            test-values:
              repo_name: test-tofu-repo
              stack_name: testapp
              github_actions_repo: test-org/github-actions
              github_actions_ref: v1.0.0
              tofu_version: latest
          - name: bicep
            test-values:
              repo_name: test-bicep-repo
              stack_name: testapp
              github_actions_repo: test-org/github-actions
              github_actions_ref: v1.0.0
              bicep_version: latest
              azure_resource_group_dev: rg-test-dev
              azure_resource_group_prod: rg-test-prod
              azure_location: eastus
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Cookiecutter
        run: pip install cookiecutter

      - name: Prepare template with test values
        run: |
          # Backup original cookiecutter.json
          cp ${{ matrix.template.name }}/cookiecutter.json \
             ${{ matrix.template.name }}/cookiecutter.json.bak

          # Write test values to cookiecutter.json
          cat > ${{ matrix.template.name }}/cookiecutter.json <<'EOF'
          ${{ toJson(matrix.template.test-values) }}
          EOF

          echo "Using test values:"
          cat ${{ matrix.template.name }}/cookiecutter.json

      - name: Generate repository from template
        run: |
          cookiecutter ${{ matrix.template.name }} \
            --no-input \
            --output-dir test-output

      - name: Restore original cookiecutter.json
        if: always()
        run: |
          mv ${{ matrix.template.name }}/cookiecutter.json.bak \
             ${{ matrix.template.name }}/cookiecutter.json

      - name: Verify generated repository structure
        run: |
          REPO_NAME="${{ matrix.template.test-values.repo_name }}"

          if [ ! -d "test-output/$REPO_NAME" ]; then
            echo "âŒ Generated repository not found"
            ls -la test-output/
            exit 1
          fi

          cd "test-output/$REPO_NAME"

          echo "ðŸ“ Generated repository structure:"
          find . -type f -name "*.tf" -o -name "*.bicep" -o -name "*.yml" -o -name "Makefile" -o -name ".gitignore" | sort

          echo "âœ… Repository generated successfully"

      - name: Verify OpenTofu template files
        if: matrix.template.name == 'opentofu'
        run: |
          cd "test-output/${{ matrix.template.test-values.repo_name }}"

          # Check for required files
          REQUIRED_FILES=(
            ".github/workflows/iac.yml"
            ".gitignore"
            ".pre-commit-config.yaml"
            "Makefile"
            "README.md"
            "infra/stacks/${{ matrix.template.test-values.stack_name }}/versions.tf"
            "infra/stacks/${{ matrix.template.test-values.stack_name }}/main.tf"
            "infra/stacks/${{ matrix.template.test-values.stack_name }}/variables.tf"
            "infra/stacks/${{ matrix.template.test-values.stack_name }}/outputs.tf"
            "infra/stacks/${{ matrix.template.test-values.stack_name }}/backend.azure.hcl.example"
            "env/dev.tfvars.example"
            "env/prod.tfvars.example"
          )

          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Required file missing: $file"
              exit 1
            fi
            echo "âœ… Found: $file"
          done

      - name: Verify Bicep template files
        if: matrix.template.name == 'bicep'
        run: |
          cd "test-output/${{ matrix.template.test-values.repo_name }}"

          # Check for required files
          REQUIRED_FILES=(
            ".github/workflows/iac.yml"
            ".gitignore"
            ".pre-commit-config.yaml"
            "Makefile"
            "README.md"
            "infra/bicep/main.bicep"
            "env/dev.bicepparam"
            "env/prod.bicepparam"
          )

          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Required file missing: $file"
              exit 1
            fi
            echo "âœ… Found: $file"
          done

      - name: Validate generated workflow YAML
        run: |
          cd "test-output/${{ matrix.template.test-values.repo_name }}"

          pip install yamllint

          echo "Validating workflow YAML files..."
          yamllint .github/workflows/*.yml

      - name: Check for template variables in generated files
        run: |
          cd "test-output/${{ matrix.template.test-values.repo_name }}"

          # Look for any remaining {{cookiecutter.* }} variables
          if grep -r "{{cookiecutter\." . --include="*.tf" --include="*.yml" --include="*.bicep" --include="Makefile"; then
            echo "âŒ Found unreplaced cookiecutter variables"
            exit 1
          fi

          echo "âœ… No unreplaced cookiecutter variables found"

      - name: Verify .gitignore excludes sensitive files
        run: |
          cd "test-output/${{ matrix.template.test-values.repo_name }}"

          # Check that .gitignore contains important exclusions
          REQUIRED_IGNORES=(
            "*.tfstate"
            "*.tfvars"
            "backend.hcl"
            ".terraform"
          )

          for pattern in "${REQUIRED_IGNORES[@]}"; do
            if ! grep -q "$pattern" .gitignore; then
              echo "âŒ .gitignore missing pattern: $pattern"
              exit 1
            fi
            echo "âœ… .gitignore contains: $pattern"
          done

      - name: Upload generated repository as artifact
        uses: actions/upload-artifact@v4
        with:
          name: generated-${{ matrix.template.name }}-repo
          path: test-output/${{ matrix.template.test-values.repo_name }}
          retention-days: 7

  # Test 3: Validate generated OpenTofu code
  test-generated-tofu-code:
    runs-on: ubuntu-latest
    needs: test-template-generation
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Cookiecutter
        run: pip install cookiecutter

      - name: Generate OpenTofu repository
        run: |
          # Use default values from cookiecutter.json
          cookiecutter opentofu --no-input \
            --output-dir test-output

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: latest

      - name: Test OpenTofu init
        working-directory: test-output/my-iac-repo/infra/stacks/app
        run: |
          # Use local backend for testing
          tofu init -input=false

      - name: Test OpenTofu format
        working-directory: test-output/my-iac-repo/infra/stacks/app
        run: |
          tofu fmt -check -recursive

      - name: Test OpenTofu validate
        working-directory: test-output/my-iac-repo/infra/stacks/app
        run: |
          tofu validate

      - name: Test Makefile targets
        working-directory: test-output/my-iac-repo
        run: |
          # Test that Makefile targets work
          make fmt || echo "âš ï¸  Makefile fmt target needs work"

          echo "âœ… Makefile syntax valid"

  # Test 4: Validate generated Bicep code
  test-generated-bicep-code:
    runs-on: ubuntu-latest
    needs: test-template-generation
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Cookiecutter
        run: pip install cookiecutter

      - name: Generate Bicep repository
        run: |
          # Use default values from cookiecutter.json
          cookiecutter bicep --no-input \
            --output-dir test-output

      - name: Setup Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

      - name: Install Bicep
        run: |
          az bicep install
          az bicep version

      - name: Test Bicep build
        working-directory: test-output/my-bicep-repo/infra/bicep
        run: |
          az bicep build --file main.bicep

      - name: Test Bicep lint
        working-directory: test-output/my-bicep-repo/infra/bicep
        run: |
          az bicep lint --file main.bicep || echo "âš ï¸  Bicep has linting warnings"

      - name: Verify ARM template generated
        working-directory: test-output/my-bicep-repo/infra/bicep
        run: |
          if [ ! -f main.json ]; then
            echo "âŒ ARM template not generated"
            exit 1
          fi
          echo "âœ… ARM template generated"

  # Test 5: Test pre-commit hooks in generated repos
  test-generated-precommit:
    runs-on: ubuntu-latest
    needs: test-template-generation
    strategy:
      matrix:
        template: [opentofu, bicep]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Cookiecutter and pre-commit
        run: |
          pip install cookiecutter pre-commit

      - name: Generate repository
        run: |
          # Use default values from cookiecutter.json
          cookiecutter ${{ matrix.template }} --no-input \
            --output-dir test-output

      - name: Determine repository name
        id: repo_name
        run: |
          if [ "${{ matrix.template }}" = "opentofu" ]; then
            echo "name=my-iac-repo" >> $GITHUB_OUTPUT
          else
            echo "name=my-bicep-repo" >> $GITHUB_OUTPUT
          fi

      - name: Validate pre-commit config
        working-directory: test-output/${{ steps.repo_name.outputs.name }}
        run: |
          if [ ! -f .pre-commit-config.yaml ]; then
            echo "âŒ .pre-commit-config.yaml not found"
            exit 1
          fi

          # Validate YAML syntax
          python -c "import yaml; yaml.safe_load(open('.pre-commit-config.yaml'))"

          echo "âœ… pre-commit config is valid"

      - name: Test pre-commit installation
        working-directory: test-output/${{ steps.repo_name.outputs.name }}
        run: |
          git init
          git config user.name "Test User"
          git config user.email "test@example.com"

          # Try to install hooks (may fail due to missing tools, but config should be valid)
          pre-commit install || echo "âš ï¸  Some hooks couldn't install (expected in test environment)"

  # Test 6: Integration test - verify generated workflow can be parsed
  test-generated-workflows:
    runs-on: ubuntu-latest
    needs: test-template-generation
    strategy:
      matrix:
        template: [opentofu, bicep]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Cookiecutter
        run: pip install cookiecutter

      - name: Generate repository
        run: |
          # Use default values from cookiecutter.json
          cookiecutter ${{ matrix.template }} --no-input \
            --output-dir test-output

      - name: Determine repository name
        id: repo_name
        run: |
          if [ "${{ matrix.template }}" = "opentofu" ]; then
            echo "name=my-iac-repo" >> $GITHUB_OUTPUT
          else
            echo "name=my-bicep-repo" >> $GITHUB_OUTPUT
          fi

      - name: Validate generated workflow references
        working-directory: test-output/${{ steps.repo_name.outputs.name }}
        run: |
          # Check that workflows reference the correct org/repo
          if ! grep -q "test-org/github-actions" .github/workflows/iac.yml; then
            echo "âŒ Workflow doesn't reference correct actions repo"
            exit 1
          fi

          # Check that workflows reference correct version
          if ! grep -q "@v1.0.0" .github/workflows/iac.yml; then
            echo "âŒ Workflow doesn't reference correct version"
            exit 1
          fi

          echo "âœ… Generated workflows reference correct reusable workflows"

      - name: Check workflow uses correct template values
        working-directory: test-output/${{ steps.repo_name.outputs.name }}
        run: |
          # Verify no hardcoded paths remain
          if grep -q "{{cookiecutter" .github/workflows/iac.yml; then
            echo "âŒ Found unreplaced cookiecutter variables in workflow"
            exit 1
          fi

          echo "âœ… Workflow properly templated"

  # Summary job
  test-summary:
    runs-on: ubuntu-latest
    needs:
      - validate-template-structure
      - test-template-generation
      - test-generated-tofu-code
      - test-generated-bicep-code
      - test-generated-precommit
      - test-generated-workflows
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "## Cookiecutter Template Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Template Structure | ${{ needs.validate-template-structure.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Template Generation | ${{ needs.test-template-generation.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Generated OpenTofu Code | ${{ needs.test-generated-tofu-code.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Generated Bicep Code | ${{ needs.test-generated-bicep-code.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-commit Config | ${{ needs.test-generated-precommit.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Generated Workflows | ${{ needs.test-generated-workflows.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY

          # Fail if any tests failed
          if [ "${{ needs.validate-template-structure.result }}" != "success" ] || \
             [ "${{ needs.test-template-generation.result }}" != "success" ] || \
             [ "${{ needs.test-generated-tofu-code.result }}" != "success" ] || \
             [ "${{ needs.test-generated-bicep-code.result }}" != "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **Some tests failed. Please review and fix before merging.**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **All cookiecutter template tests passed!**" >> $GITHUB_STEP_SUMMARY
